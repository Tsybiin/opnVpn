#!/bin/bash
# пример bash createVpnKeys {password rsa}
EXPECT_TEXT="Enter pass phrase for /etc/openvpn/pki/private/ca.key:"
KEY_DIR=/home/tsybin/keysVpn/$NAME
OUTPUT_DIR=/home/tsybin/keysVpn/$NAME
BASE_CONFIG=/home/tsybin/keysVpn/base.conf
COMMAND="./easyrsa build-client-full $NAME nopass"
# TODO пароль вводитьь в консоли
countkey=$2
password=$1'\n'
echo $password
echo $countkey

cd /var/www/opnVpn/keys/new
count=1
while [ $count -le 1  ]
do
  NAME=v_$(date +%s)
#create key
COMMSHOW="
puts $(pwd)
    set timeout 3
    spawn docker compose run --rm openvpn easyrsa build-client-full $NAME nopass
    expect \"$exShow\"
    send \"$password\"
    expect \"Data Base Updated\"
    send \"done\"
expect eof "

expect -c "$COMMSHOW"

docker compose run --rm openvpn ovpn_getclient $NAME > $NAME.ovpn

if grep -q "error" "$NAME.ovpn"; then
   rm $NAME.ovpn
   echo "error creating certificate" $NAME.ovpn
   exit 1  # Завершение с кодом 1 (можно любой другой)
else
   echo "key create: $NAME.ovpn"
fi
  count=$((count + 1))
done
scp -r  /var/www/opnVpn/keys/new/* old@31.59.174.111:/var/www/newSimpl/simp/var/www/keys/new
mv * /var/www/opnVpn/keys/send
